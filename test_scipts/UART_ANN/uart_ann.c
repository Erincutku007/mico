#define AXIUARTADDRRESS 0xC0000000
#define FPGAIOADDRRESS 0x80000000

void seven_segment_display(volatile int num,volatile int* io_ptr){
    volatile int *seg_ptr = io_ptr + 1;
    int disp_LUT[10] = {64,121,36,48,25,18,2,120,0,16};
    
    volatile int seg;
    seg = disp_LUT[num];
    *seg_ptr = seg;
}

volatile int read_word(volatile int* uart_ptr, volatile int* io_ptr){
    volatile int j = 0;
    volatile int word;
    volatile int status,rx_fifo_status;
    volatile int uart_rx_data;
    word = 0;
        for (j = 0; j < 4; j++)
        {
            //*io_ptr = j;
            rx_fifo_status = 0;
            while (rx_fifo_status == 0) {
                status = *(uart_ptr+2);
                rx_fifo_status = status & 1;
            }
            uart_rx_data = *(uart_ptr);
            word = word | (uart_rx_data << 8*(3-j));
        }
    return word;
}

void load_mem(volatile float* array,int size, volatile int* uart_ptr, volatile int* io_ptr){
    volatile int i = 0;
    volatile int word_i;
    *io_ptr = 4;
    for (i = 0; i < size; i++)
    {
        word_i   = read_word(uart_ptr,io_ptr);
        array[i] = *( (float*) (&word_i))  ;
    }
    *io_ptr = 5;
}

volatile float dot( volatile float* a, volatile float* b, volatile int size){
    volatile int i;
    volatile float sum,product;
    sum = 0;
    for (i = 0; i < size; i++)
    {
        product = a[i] * b[i];
        sum     = sum  + product  ;
    }
    return sum;
}


int main() 
{
    volatile int *uart_ptr = AXIUARTADDRRESS;
    volatile int *io_ptr   = FPGAIOADDRRESS;
    volatile int *test_adr = 20000;

    volatile float a1[10];//     = {0.00000000000000000,8.54031062422597920,4.67106029880138607,1.05624861934545100,5.23334291412195807,6.62384207574746409,3.59715106279508179,2.10777567243190633,1.09235694984205756,0.00000000000000000};
    volatile float w2[10][10] = {{-0.18408639720321440,-0.06240403829762059,0.84806866862702524,-0.50215345287150726,-0.17823859301537906,-0.28605774321887983,-0.02413281575435868,-0.61363384887748773,-0.06419777365960448,-0.32955382151368473},{-0.66260617006582267,0.07698014379965001,-0.78636536816173752,0.19808080322668431,-0.15093859437641644,-0.02951189082955654,-0.64039966102932688,1.00947584099557752,-0.04966050925457124,-0.06864213600711890},{0.04455957805459237,0.84069592674570337,0.20942200829103452,-0.23035141915441806,-0.38704819754670194,-0.11974384829822805,-0.11718581355207344,0.25809170568252865,-0.19089963986907163,0.37096160287676749},{-0.66553698815727946,0.11409475599857394,0.48025134503857297,0.11017826195461515,-0.02725166748052308,-0.13074999409910579,-0.03459893865458254,0.35742672934288983,0.16239161544433789,0.22232697706797080},{0.42228927211795336,-0.03180475362248406,-0.62412735417772780,-0.22255994322737199,0.00971100691740560,0.18579955926593042,0.68246556223769550,-0.19054643951950948,-0.04738563875921634,-0.07780908470217689},{-0.16075219266773955,0.07707258441885410,0.28857048340380098,-0.02748487671217962,0.70639735507850232,0.68809504263751819,-0.08530233361480852,-0.26308339579345785,0.05064032522905957,0.32178803157372637},{0.94010796246766870,0.02838012454445570,-0.21878335994816159,0.25215527946367966,-0.10749548711212330,0.18526242561165163,-0.36258164169501544,-0.21461001750643835,-0.24922524398552412,0.51268501997707305},{-0.87753836109251504,0.61378496235937119,-0.02525687995374171,0.78253598125926538,-0.25976708645828273,-0.01429134098191876,0.73849668546639646,0.01911120668430700,-0.14666135146097314,-0.22445002036999004},{-0.10007930147677312,-0.00205168078713682,-0.03105420470011354,-0.09584380857956613,0.54323455517622909,-0.15527505388544038,0.02993881749880250,0.27428735908375118,-0.11035971752342769,-0.00196660639256569},{-0.39056198564384592,-0.15234548806655235,-0.21352072774855713,-0.35002425987008812,0.07478332249196640,0.21299856894386066,0.88541089694747521,0.03938077155147179,0.37033750985757546,0.24005007129387490}};
    volatile float b2[10]     = {0.18001222819744678,-0.39021379565556280,-0.02165206493823169,0.05709955630675179,-0.15193172846893965,-0.04954081206822991,-0.36554345007746636,0.32996888865375074,-0.08690991441353468,-0.30043513403880051};
    volatile float a2[10];
    
    *(io_ptr+2) = 1;//DP = 1
    *(io_ptr+3) = 14;//an = 1

    while (1)
    {

    load_mem(a1,10,uart_ptr,io_ptr);

    *io_ptr = 1;

    volatile int i;
    for (i = 0; i < 10; i++)
    {
        a2[i] = dot(w2[i] , a1 , 10);
    }

    *io_ptr = 2;

    volatile float res       = a2[0];
	volatile int   res_index = 0;
	
	for (i = 1; i<10 ; i++) {
    	if ( res < a2[i]){
    		res_index = i;
    		res = a2[i];
		}
	}
    
        *io_ptr = res_index;
        seven_segment_display(res_index,io_ptr);
    }

    return 0;
}




